# ScriptGuard Configuration — RunPod Optimized (RTX 3090/4090/A5000 24GB VRAM)
# Final Production Version - FIXED FOR 1:1 BALANCE & SPECIFICITY IMPROVEMENT

# ============================================================================
# PIPELINE CONFIGURATION
# ============================================================================
pipeline:
  enable_cache: true
  cache_ttl_hours: 24
  cache_key_includes_version: true
  cache_invalidation_on_config_change: true

  cache_steps:
    advanced_data_ingestion: true
    validate_samples: true
    augment_malicious_samples: true
    train_model: false  # Always train fresh to avoid state pollution

# ============================================================================
# API KEYS & NETWORK CONFIGURATION
# ============================================================================
api_keys:
  github_token: ${GITHUB_API_TOKEN}
  nvd_api_key: ${NVD_API_KEY}
  malwarebazaar_api_key: ${MALWAREBAZAAR_API_KEY}
  huggingface_token: ${HUGGINGFACE_TOKEN}
  scriptguard_api_key: ${SCRIPTGUARD_API_KEY}

  max_retries: 3
  retry_backoff_factor: 2
  timeout_seconds: 30
  connection_pool_size: 10

# ============================================================================
# DATA SOURCES CONFIGURATION - EXPANDED FOR 1:1 BALANCE
# ============================================================================
data_sources:
  github:
    enabled: true
    fetch_malicious: true
    fetch_benign: true
    timeout: 30
    max_retries: 3

    malicious_keywords:
      - "reverse-shell python"
      - "keylogger python"
      - "ransomware python"
      - "backdoor python"
      - "credential stealer python"
      - "port scanner python"
      - "exploit python"
      - "payload python"
      - "data exfiltration python"

    benign_repos:
      # Core Frameworks & Web
      - "django/django"
      - "pallets/flask"
      - "psf/requests"
      - "tiangolo/fastapi"
      - "aio-libs/aiohttp"
      # System Administration & DevOps (Critical for FP prevention)
      - "ansible/ansible"         # Uses subprocess and remote execution legally
      - "fabric/fabric"           # SSH and remote command execution
      - "saltstack/salt"          # Infrastructure management
      - "pallets/click"           # CLI argument parsing
      - "Textualize/rich"         # Terminal formatting
      # Security & Crypto (Proper legal patterns)
      - "pyca/cryptography"       # Proper crypto implementation
      - "certifi/python-certifi"
      # Data Processing & Cloud
      - "scikit-learn/scikit-learn"
      - "pandas-dev/pandas"
      - "pytorch/pytorch"
      - "boto/boto3"              # AWS SDK (heavy network operations)

    max_samples_per_keyword: 400   # Increased to match benign counts
    max_files_per_repo: 800       # Increased for better diversity

  malwarebazaar:
    enabled: true
    timeout: 60
    max_retries: 3
    tags: ["python", "script", "ransomware", "backdoor", "stealer"]
    max_samples: 1500

  vxunderground:
    enabled: true
    timeout: 60
    max_retries: 3
    script_types: [".py", ".ps1", ".js", ".vbs"]
    max_samples: 1500

  thezoo:
    enabled: true
    timeout: 60
    max_retries: 3
    script_types: [".py", ".ps1", ".js", ".vbs", ".sh"]
    max_samples: 1000

  huggingface:
    enabled: false
    timeout: 120
    max_retries: 3
    datasets: ["codeparrot/github-code"]
    max_samples: 20000

  cve_feeds:
    enabled: true
    timeout: 45
    max_retries: 3
    days_back: 180
    keywords: ["script", "code execution", "command injection", "python", "malicious"]

  additional_hf:
    enabled: true
    timeout: 120
    max_retries: 3
    max_samples_per_dataset: 400

    malware_datasets:
      - naorm/malware-text-db
      - rr4433/Powershell_Malware_Detection_Dataset
      - pacificsun/Malware_10k
      - cw1521/ember2018-malware-v2

    classification_datasets:
      - deepcode-ai/Malware-Prediction
      - PurCL/malware-top-100-labels
      - RanggaAS/malware_detection

# ============================================================================
# DATABASE & VECTOR STORE CONFIGURATION
# ============================================================================
database:
  type: "postgresql"
  postgresql:
    host: ${POSTGRES_HOST:-localhost}
    port: ${POSTGRES_PORT:-5432}
    database: ${POSTGRES_DB:-scriptguard}
    user: ${POSTGRES_USER:-scriptguard}
    password: ${POSTGRES_PASSWORD:-scriptguard}

qdrant:
  host: ${QDRANT_HOST:-localhost}
  port: ${QDRANT_PORT:-6333}
  collection_name: "malware_knowledge"
  embedding_model: "all-MiniLM-L6-v2"
  prefer_grpc: true

# ============================================================================
# CODE EMBEDDING & RAG CONFIGURATION
# ============================================================================
code_embedding:
  model: "microsoft/unixcoder-base"
  fewshot:
    enabled: true
    k: 3
    balance_labels: true

  hierarchical:
    enabled: true
    max_function_tokens: 1024
    fallback_to_sliding: true
    languages: ["python"]

  score_thresholds:
    "microsoft/unixcoder-base":
      default: 0.50  # Increased from 0.35 to reduce False Positives

  reranking:
    enabled: true
    heuristic:
      enabled: true
      security_keywords: ["os.system", "subprocess", "exec", "eval", "socket", "pickle.loads", "base64.b64decode"]

# ============================================================================
# DATA VALIDATION & AUGMENTATION
# ============================================================================
validation:
  validate_syntax: true
  skip_syntax_errors: true
  min_length: 50
  max_length: 100000

augmentation:
  enabled: true
  variants_per_sample: 3
  techniques: ["base64", "hex", "rename_vars", "split_strings"]

  # Crucial for fixing the Specificity: 0.00 issue
  balance_dataset: true
  target_balance_ratio: 1.0       # Force 1:1 split (50% Malicious / 50% Benign)
  balance_method: "oversample"

# ============================================================================
# TRAINING CONFIGURATION — OPTIMIZED FOR ANTI-OVERFITTING
# ============================================================================
training:
  model_id: "bigcode/starcoder2-3b"
  output_dir: ${MODEL_OUTPUT_DIR:-/workspace/models/scriptguard-model}

  device: cuda
  gradient_checkpointing: true
  use_flash_attention_2: true
  group_by_length: true

  # Batching Strategy
  per_device_train_batch_size: 2
  per_device_eval_batch_size: 2
  gradient_accumulation_steps: 16

  # QLoRA - Higher regularization to fight overfitting
  use_qlora: true
  lora_r: 8
  lora_alpha: 16
  lora_dropout: 0.1                # Increased from original to generalize better
  target_modules: ["q_proj", "v_proj", "k_proj", "o_proj", "gate_proj", "up_proj", "down_proj"]

  # Duration - 1 Epoch is enough for this dataset size
  num_epochs: 1

  # Optimizer - Conservative settings
  learning_rate: 5e-5              # Reduced from 2e-4
  weight_decay: 0.1                # Increased from 0.01 for better regularization
  warmup_steps: 50
  lr_scheduler_type: "cosine"
  optim: "paged_adamw_8bit"

  # Monitoring
  evaluation_strategy: "steps"
  eval_steps: 50                   # Frequent checks to monitor overfitting
  save_steps: 50
  test_split_size: 0.2
  load_best_model_at_end: true

  early_stopping: true
  early_stopping_patience: 3       # Reduced for faster cut-off
  metric_for_best_model: "eval_loss"

  bf16: true
  tf32: true

  report_to: ["wandb"]
  run_name: ${WANDB_RUN_NAME:-scriptguard-balanced-v2}

# ============================================================================
# INFERENCE & LOGGING
# ============================================================================
inference:
  host: "0.0.0.0"
  port: 8000
  max_length: 2048
  temperature: 0.1                 # Deterministic output for security auditing
  top_p: 0.95

logging:
  level: ${LOG_LEVEL:-INFO}
  file: ${LOG_FILE:-/workspace/logs/scriptguard.log}

runpod:
  pod_id: ${RUNPOD_POD_ID:-}
  volume_mount: ${RUNPOD_VOLUME_PATH:-/workspace}
  test_network_on_startup: true